package br.gaveteiro.senai.dao;

import java.util.List;
import java.util.Random;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;

import org.springframework.mail.SimpleMailMessage;
import org.springframework.stereotype.Repository;
import br.gaveteiro.senai.modelo.Usuario;

@Repository
public class UsuarioDao {
	@PersistenceContext
	private EntityManager manager;
	
	public void inserir(Usuario usuario)
	{
		manager.persist(usuario);
	}

	public List<Usuario> listar(){
		
		 TypedQuery<Usuario> query = manager.createQuery("SELECT u FROM Usuario u", Usuario.class);
		 return query.getResultList();
	}
	
	
	public Usuario listar(Long idUsuario){
		 Usuario usuario = manager.find(Usuario.class, idUsuario);
		 return usuario;
	}
	
	public List<Usuario> listarPorEmpresa(Long idEmpresa)
	{
		TypedQuery<Usuario> query = manager.createQuery("SELECT u FROM Usuario u WHERE u.empresa.idEmpresa = :idEmpresa", Usuario.class);
		query.setParameter("idEmpresa", idEmpresa);
		return query.getResultList();
		
	}
	
	public Usuario logar(Usuario usuario)
	{
		TypedQuery<Usuario> query = manager.createQuery("select u from Usuario u where u.login = :login and u.senha = :senha", Usuario.class);
		query.setParameter("login", usuario.getLogin());
		query.setParameter("senha", usuario.getSenha());
		try {
			return query.getSingleResult();
		} catch (NullPointerException e) {
			return null;
		} catch (Exception e) {
			e.printStackTrace();
			return null;
		}
		
	}
	
	public Boolean recuperarSenha(Usuario usuario)
	{
		try {
			TypedQuery<Usuario> query = manager.createQuery("select u From Usuario u where u.email = :email", Usuario.class);
			usuario = query.getSingleResult();
			Random random = new Random();
			char[] chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890".toCharArray();
			String senha = "";
			for(int i = 0; i <= 5;i++)
				senha += chars[random.nextInt(chars.length)];
			usuario.setSenha(senha);
			manager.merge(usuario);
			SimpleMailMessage email = new SimpleMailMessage();
			email.setTo(usuario.getEmail());
			email.setSubject("Gaveteiro - Solicitação de Alteração de Senha");
			email.setText("Olá "+usuario.getNome()+"\n sua nova senha é: "+usuario.getSenha());
			
			
			return true;
		} catch (Exception e) {
			e.printStackTrace();
			return false;
		}
	}

}
